!function(){"use strict";function a(r){return r.trim().replace(/(\s+)|(\(\s+)|(\)\s+$)|("\s+)|(\s+\))/gi,function(r,t,e,n,o,s){return t?" ":e?"(":n||s?")":o?'" ':void 0})}window.normalizeFieldAndReturnArray=function(r){var t=[];return r&&(r instanceof Array?t=r:""!==r&&(t=r.split(" AND "))),t};var e,i,p,u,c="bool",l="term",h="quoted_term",d="search_group",o="query",r=(i=e=null,p=!1,u=0,s.prototype.add=function(r){return this.left||this.right?this.right?r=!1:(this.right=r,this.complete=!0,r.parent=this):(this.left=r).parent=this,r},f.prototype.add=t,f.prototype.swap=n,m.prototype.add=t,m.prototype.swap=n,{procs:{procBool:function(r){return y(s,c,r)},procTerm:function(r){return T(l,r)},procQuotedTerm:function(r){return T(h,r)},procGroup:function(r){u+=1;r=y(f,d,r);return 1===u&&(p=r),r},procGroupEnd:function(){0<u&&--u}},reset:function(){u=0,i=p=null,e=!1},parse:function(r){if(!r)return{error:"No source specified for parsing."};if(this.reset(),t=(t=r).trim(),!(r=!/^AND|^OR|^NOT/.test(t)&&t))return{error:"Parse error: Queries may not begin with a boolean keyword."};e=new f({parserType:o,nodeType:"root"}),i=e;var t=R.parse(r);return t.status?e:{error:Parsimmon.formatError(r,t)}}});function t(r,t){try{return this.complete?this.swap(r,t):(((this.child=r).parent=this).complete=!0,r)}catch(r){}}function n(r,t){var e=!1;p&&0===u?(s=p,e=!(p=null)):s=this;var n=s.parent;if(!n)return!1;var o=n.child?"child":n.right?"right":!!n.children&&"children";if(o){var s=n[o];return(n[o]=r).parent=n,t||(e?r.add(s):r.add(this)),r}return!1}function s(r){this.parserType=r.parserType,this.nodeType=r.nodeType,this.left=r.left,this.right=r.right,this.complete=!1,this.tt="NOT"===this.nodeType?{left:!0,right:!1}:{left:!0,right:!0}}function f(r){this.parserType=r.parserType,this.nodeType=r.nodeType,this.child=r.child,this.complete=!!r.child}function m(r){this.parserType=r.parserType,this.val=r.val,this.complete=!!this.val}function y(r,t,e,n){var o=p&&0===u?p:i;if(o.val&&((o.parserType===l||o.parserType===h)&&t===l||t===h)){var s=new m({parserType:h,val:o.val+" "+n});return i=s,o.add(s,!0)}r=o.add(new r({parserType:t,nodeType:e,val:n}));return r?i=r:(Parsimmon.fail("Parser error:  "+t+" -> Could not add node: "+e+" with value -> "+n),!1)}function T(r,t){return y(m,r,null,t)}window.QueryParser=r;var v=Parsimmon.string,g=Parsimmon.optWhitespace,b=Parsimmon.alt,w=Parsimmon.regex,k=Parsimmon.seq,P=Parsimmon.lazy;function N(r){return v(r).skip(g)}var A=N("("),O=N(")"),Q=N("'"),E=N('"'),z=N("AND"),D=N("OR"),L=N("NOT"),R=P(function(){return G.or($)}),z=b(z,D,L).map(r.procs.procBool),D=w(/(?!\bAND|NOT|OR\b)[a-zA-Z'\d\+\-\.\/,&\*\^!\$\{\}\:\;<>\[\]#@]+/).skip(g).map(r.procs.procTerm),L=w(/[a-zA-Z"\d\+\.\s\-\/,&\*\^\!\$\{\}\:\;<>\[\]#@]+/).map(r.procs.procQuotedTerm),w=w(/[a-zA-Z'\d\+\.\s\-\/,&\*\^\!\$\{\}\:\;<>\[\]#@]+/).map(r.procs.procQuotedTerm),D=D.atLeast(1),D=b(Q.then(L).skip(Q),E.then(w).skip(E),D),G=k(z.atMost(1),D.or(P(function(){return $}))).atLeast(1),$=k(z.atMost(1),A.map(r.procs.procGroup).then(R.atLeast(1).skip(O.map(r.procs.procGroupEnd))));function q(r,t){var e=[{ast:r,done:!1}];e.last=function(){return e[e.length-1]};for(var n=null;n=e.last();)n.done?e.pop():n.ast.parserType===o?(e.push({ast:n.ast.child,done:!1}),n.done=!0,t[o]&&t[o](n,e)):n.ast.parserType===c?n.marker?(n.done=!0,n.marker=!1,n.ast.right&&(t[c].end&&t[c].end(n,e),e.push({ast:n.ast.right,done:!1}))):(n.marker=!0,n.ast.left&&(t[c].begin&&t[c].begin(n,e),e.push({ast:n.ast.left,done:!1}))):n.ast.parserType===l?(n.done=!0,t[l]&&t[l](n,e),n.ast.child&&e.push({ast:n.ast.child,done:!1})):n.ast.parserType===h?(n.done=!0,t[h]&&t[h](n,e),n.ast.child&&e.push({ast:n.ast.child,done:!1})):n.ast.parserType===d&&(n.marker?(n.done=!0,n.marker=!1,t[d]&&t[d].end(n,e)):(n.marker=!0,t[d]&&t[d].begin(n,e),e.push({ast:n.ast.child,done:!1})))}r=(q.makeProcessor=function(t){return function(r){return!r||r.error?[]:t(r)}})(function(r){var t="",e={};return e[c]={end:function(r){t+=r.ast.nodeType}},e[l]=function(r){t+=" "+r.ast.val+" "},e[h]=function(r){t+=' "'+r.ast.val+'" '},e[d]={begin:function(){t+=" ("},end:function(){t+=") "}},q(r,e),a(t)});window.astToQueryStr=r;r=q.makeProcessor(function(r){var e=[],n=!0,t={},o=0;return t[c]={begin:function(r){"NOT"===r.ast.nodeType&&((r=r.ast.tt.left)===n?n=!0:r||(n=!1))},end:function(r){"NOT"===r.ast.nodeType&&((r=r.ast.tt.right)===n?n=!0:r||(n=!1))}},t[d]={begin:function(){o+=1},end:function(){--o}},t[h]=function(r){var t=r.ast;n?e.push(r.ast.val):(t.parent&&t.parent.left===t&&0===o||t.parent&&t.parent.right===t)&&(n=!0)},t[l]=t[h],q(r,t),e});window.astToInclusiveTerms=r;r=q.makeProcessor(function(r){var n=[{bools:[],terms:[]}],o=0,t={};t[c]={end:function(r){var t=n[n.length-1];t.bools[t.terms.length]=r.ast.nodeType}},t[l]=function(r,t){var e=n[n.length-1];t[t.length-2].ast.parserType===c&&0===o&&(t=[e.bools.pop()],n.push({bools:t,terms:[]}),e=n[n.length-1]),e.terms.push(r.ast.val)},t[h]=function(r,t){var e=n[n.length-1];t[t.length-2].ast.parserType===c&&0===o&&(t=[e.bools.pop()],n.push({bools:t,terms:[]}),e=n[n.length-1]),e.terms.push('"'+r.ast.val+'"')},t[d]={begin:function(){var r,t=n[n.length-1];1===(o+=1)&&(r=[t.bools.pop()],n.push({bools:r,terms:[]}),t=n[n.length-1]),t.terms.push("(")},end:function(){var r=n[n.length-1];--o,r.terms.push(")"),0===o&&n.push({bools:[],terms:[]})}},q(r,t);var s=[];return n.forEach(function(r,t){var n,o,e=r.terms;0!==e.length&&(n={bool:"empty",str:""},o=r.bools,s.push(n),0!==t&&(n.bool=o[0]),e.forEach(function(r,t){var e=/AND|OR|NOT/.test(r)?" ":"";n.str+=e+r+e,o[t+1]&&(n.str+=" "+o[t+1]+" ")}),n.str=a(n.str),n.ind=t)}),s});window.astToMultiValueList=r,window.valueListToQueryStr=function(r){var t="";return r.forEach(function(r){r.bool&&"empty"!==r.bool&&(t+=" "+r.bool+" "),t+=r.str}),a(t)}}();